name: Security Checks

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run security checks weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check license headers
        run: |
          echo "Checking for Apache License headers in Java files..."
          missing_headers=0
          
          # Find all Java files (excluding build directories and generated code)
          find . -name "*.java" \
            -not -path "*/build/*" \
            -not -path "*/generated/*" \
            -not -path "*/.gradle/*" | while read -r file; do
            
            # Check if file contains Apache License header
            if ! grep -q "Apache License" "$file"; then
              echo "‚ùå Missing license header: $file"
              missing_headers=$((missing_headers + 1))
            fi
          done
          
          if [ $missing_headers -gt 0 ]; then
            echo "‚ö†Ô∏è Found $missing_headers file(s) missing license headers"
            echo "Please add the Apache License 2.0 header to all Java files"
            exit 1
          else
            echo "‚úÖ All Java files have proper license headers"
          fi

      - name: Verify required files exist
        run: |
          echo "Checking for required legal files..."
          required_files=(
            "LICENSE"
            "NOTICE"
            "SECURITY.md"
            "CODE_OF_CONDUCT.md"
            "CONTRIBUTING.md"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              missing=$((missing + 1))
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "‚ö†Ô∏è Missing $missing required file(s)"
            exit 1
          fi

  sensitive-data-check:
    name: Sensitive Data Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for accidentally committed secrets
        run: |
          echo "Checking for sensitive files that should not be committed..."
          
          sensitive_patterns=(
            "config.json"
            "service-account.json"
            "*.key"
            "*.pem"
            "*.p12"
            ".env"
            "id_rsa"
            "id_dsa"
            "*.ppk"
            "database.properties"
            "oauth-secrets.json"
            "client_secret*.json"
          )
          
          found_sensitive=0
          for pattern in "${sensitive_patterns[@]}"; do
            files=$(find . -name "$pattern" -not -path "*/build/*" -not -path "*/.gradle/*" 2>/dev/null || true)
            if [ -n "$files" ]; then
              echo "‚ö†Ô∏è Found potentially sensitive file(s) matching pattern: $pattern"
              echo "$files"
              found_sensitive=1
            fi
          done
          
          if [ $found_sensitive -eq 1 ]; then
            echo ""
            echo "‚ùå Sensitive files detected in repository!"
            echo "These files should be in .gitignore and removed from git history"
            echo "If these files were committed, they should be removed and credentials rotated"
            exit 1
          else
            echo "‚úÖ No sensitive files detected in repository"
          fi

      - name: Check for hardcoded secrets in code
        run: |
          echo "Checking for potential hardcoded secrets..."
          
          # Search for common secret patterns
          secrets_found=0
          
          # Discord bot tokens
          if grep -r "discord.*token.*=.*[\"'][A-Za-z0-9._-]\{50,\}[\"']" --include="*.java" --exclude-dir="build" . ; then
            echo "‚ö†Ô∏è Possible Discord token found in code"
            secrets_found=1
          fi
          
          # Database passwords
          if grep -r "password.*=.*[\"'][^\"']\{8,\}[\"']" --include="*.java" --include="*.properties" --exclude-dir="build" . | grep -v "example" | grep -v "your_password"; then
            echo "‚ö†Ô∏è Possible hardcoded password found"
            secrets_found=1
          fi
          
          # API keys
          if grep -r "api[_-]key.*=.*[\"'][A-Za-z0-9]\{20,\}[\"']" --include="*.java" --exclude-dir="build" . ; then
            echo "‚ö†Ô∏è Possible API key found in code"
            secrets_found=1
          fi
          
          if [ $secrets_found -eq 1 ]; then
            echo ""
            echo "‚ùå Potential secrets detected in code!"
            echo "Please use environment variables or config files (that are gitignored)"
            exit 1
          else
            echo "‚úÖ No obvious hardcoded secrets detected"
          fi

  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run dependency vulnerability check
        run: ./gradlew dependencyCheckAnalyze --no-daemon || true
        continue-on-error: true

      - name: Check for outdated dependencies
        run: ./gradlew dependencyUpdates --no-daemon

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, license-check, sensitive-data-check, dependency-security]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "üîí Security scan completed"
          echo ""
          echo "Results:"
          echo "- Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "- License Compliance: ${{ needs.license-check.result }}"
          echo "- Sensitive Data Check: ${{ needs.sensitive-data-check.result }}"
          echo "- Dependency Security: ${{ needs.dependency-security.result }}"
          echo ""
          
          if [ "${{ needs.secret-scanning.result }}" == "failure" ] || \
             [ "${{ needs.license-check.result }}" == "failure" ] || \
             [ "${{ needs.sensitive-data-check.result }}" == "failure" ]; then
            echo "‚ùå Security checks failed! Please review and fix issues."
            exit 1
          else
            echo "‚úÖ All critical security checks passed!"
          fi

